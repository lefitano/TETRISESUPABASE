<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Tetris Supabase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://pfcaiafbrvqmmsbdlbiy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmY2FpYWZicnZxbW1zYmRsYml5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNzMzMjgsImV4cCI6MjA3Nzk0OTMyOH0.ie2QeYGtOPOMYk6QQPI9MzsD79oN9mFPJHx17xk0mwY";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background-color: #3d2817;
      background-image: 
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.1) 2px, rgba(0,0,0,.1) 4px),
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.1) 2px, rgba(0,0,0,.1) 4px);
      color: #e8d5c4;
      font-family: 'Georgia', serif;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      border: 8px solid #8b6f47;
      background-color: #5d4e37;
      background-image: 
        repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(0,0,0,.1) 35px, rgba(0,0,0,.1) 70px),
        repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(0,0,0,.1) 35px, rgba(0,0,0,.1) 70px);
      padding: 30px;
      box-shadow: inset 0 0 20px rgba(0,0,0,.8), 0 0 30px rgba(0,0,0,.9);
      position: relative;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: 
        repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(255,255,255,.03) 1px, rgba(255,255,255,.03) 2px),
        repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(255,255,255,.03) 1px, rgba(255,255,255,.03) 2px);
      pointer-events: none;
      z-index: 1;
    }

    h2, h3, h4 { 
      text-shadow: 2px 2px 4px rgba(0,0,0,.8);
      border-bottom: 3px solid #8b6f47;
      padding-bottom: 10px;
      margin-bottom: 15px;
      font-weight: bold;
      letter-spacing: 2px;
      color: #f4d03f;
    }

    .btn {
      background: linear-gradient(135deg, #8b6f47 0%, #5d4e37 100%);
      border: 2px solid #3d2817;
      color: #e8d5c4;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,.8);
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0,0,0,.6);
    }

    .btn:hover {
      background: linear-gradient(135deg, #a08b5c 0%, #6d5e47 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,.8);
    }

    .btn-primary { background: linear-gradient(135deg, #c41e3a 0%, #8b1428 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #d63050 0%, #a02844 100%); }
    
    .btn-success { background: linear-gradient(135deg, #8b6f47 0%, #5d4e37 100%); }
    .btn-success:hover { background: linear-gradient(135deg, #a08b5c 0%, #6d5e47 100%); }

    .btn-secondary { background: linear-gradient(135deg, #8b7355 0%, #5d4e37 100%); }
    .btn-secondary:hover { background: linear-gradient(135deg, #a08b5c 0%, #6d5e47 100%); }

    .btn-danger { background: linear-gradient(135deg, #8b3a3a 0%, #5d2828 100%); }
    .btn-danger:hover { background: linear-gradient(135deg, #a85252 0%, #704040 100%); }

    .form-control {
      background-color: #4a3d30;
      border: 2px solid #8b6f47;
      color: #e8d5c4;
      font-family: 'Georgia', serif;
    }

    .form-control::placeholder { color: #a08b5c; }
    .form-control:focus {
      background-color: #5a4d40;
      border-color: #f4d03f;
      color: #e8d5c4;
      box-shadow: 0 0 10px rgba(244, 208, 63, 0.5);
    }

    .list-group-item {
      background-color: #4a3d30;
      border: 2px solid #8b6f47;
      color: #e8d5c4;
      margin-bottom: 8px;
    }

    #tetris {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 1px;
      margin: 20px 0;
      border: 4px solid #3d2817;
      background-color: #1a1410;
      box-shadow: inset 0 0 10px rgba(0,0,0,.9), 0 0 15px rgba(0,0,0,.8);
      aspect-ratio: 1;
      width: 100%;
    }

    .celula { 
      width: 100%;
      height: 100%;
      background-color: #1a1410;
      border: 1px solid #2a241a;
    }

    .row { position: relative; z-index: 2; }

    #loginTela, #cadastroTela { display: none; }
    #jogoTela { display: none; }

    .text-center { text-align: center; }
  </style>
</head>
<body class="container py-5">

  <!-- ==================== LOGIN ==================== -->
  <div id="loginTela" class="text-center">
    <div style="text-align:center; margin-bottom: 30px; border: 4px solid #8b6f47; background-color: #4a3d30; padding: 20px; transform: rotate(-2deg);">
      <h1 style="font-size: 48px; text-shadow: 4px 4px 8px rgba(0,0,0,.9); letter-spacing: 3px; color: #f4d03f; margin: 0; font-family: 'Georgia', serif;">‚ö†Ô∏è TETRIS ‚ö†Ô∏è</h1>
      <p style="color: #c41e3a; text-shadow: 2px 2px 4px rgba(0,0,0,.8); margin-top: 10px; font-style: italic;">O Jogo do Oeste</p>
    </div>
    <div class="mt-3" style="background-color: #4a3d30; padding: 20px; border: 3px solid #8b6f47;">
      <h2 style="color: #f4d03f; margin-bottom: 20px;">ü§† LOGIN ü§†</h2>
      <input id="loginUsuario" class="form-control mb-2" placeholder="Apelido do Pistoleiro" autofocus>
      <input id="loginSenha" type="password" class="form-control mb-3" placeholder="Senha Secreta">
      <button id="btnLogin" class="btn btn-primary w-100 mb-2" style="font-size: 18px; font-weight: bold;">‚ö° ENTRAR NO DUELO ‚ö°</button>
      <button id="mostrarCadastro" class="btn btn-link" style="color: #f4d03f; text-decoration: underline;">Novo no Oeste? Cadastre-se</button>
    </div>
  </div>

  <!-- ==================== CADASTRO ==================== -->
  <div id="cadastroTela" class="text-center">
    <div style="text-align:center; margin-bottom: 30px; border: 4px solid #8b6f47; background-color: #4a3d30; padding: 20px; transform: rotate(2deg);">
      <h1 style="font-size: 48px; text-shadow: 4px 4px 8px rgba(0,0,0,.9); letter-spacing: 3px; color: #f4d03f; margin: 0; font-family: 'Georgia', serif;">‚ö†Ô∏è NOVO XERIFE ‚ö†Ô∏è</h1>
      <p style="color: #c41e3a; text-shadow: 2px 2px 4px rgba(0,0,0,.8); margin-top: 10px; font-style: italic;">Junte-se √† Lenda do Tetris</p>
    </div>
    <div class="mt-3" style="background-color: #4a3d30; padding: 20px; border: 3px solid #8b6f47;">
      <h2 style="color: #f4d03f; margin-bottom: 20px;">üèúÔ∏è CADASTRO üèúÔ∏è</h2>
      <input id="cadastroUsuario" class="form-control mb-2" placeholder="Apelido do Pistoleiro">
      <input id="cadastroSenha" type="password" class="form-control mb-3" placeholder="Senha (m√≠nimo 3 caracteres)">
      <div class="mb-3">
        <label for="cadastroFoto" class="form-label" style="color: #e8d5c4;">üñºÔ∏è Foto de Perfil (opcional):</label>
        <input id="cadastroFoto" type="file" class="form-control" accept="image/*">
      </div>
      <button id="btnCadastro" class="btn btn-success w-100 mb-2" style="font-size: 18px; font-weight: bold;">‚úì REGISTRAR NO SALOON ‚úì</button>
      <button id="voltarLogin" class="btn btn-link" style="color: #f4d03f; text-decoration: underline;">Voltar ao Login</button>
    </div>
  </div>

  <!-- ==================== JOGO ==================== -->
  <div id="jogoTela">
    <div class="row">
      <div class="col-6">
        <h2 style="text-align: center; color: #f4d03f; font-size: 32px;">üéÆ DUELO DO TETRIS üéÆ</h2>
        <div id="tetris"></div>
        <div class="d-flex align-items-center gap-2 mt-2">
          <div id="pontuacao" style="font-size: 18px; font-weight: bold; color: #f4d03f;">üí∞ Pontua√ß√£o: 0</div>
          <button id="pauseBtn" class="btn btn-secondary btn-sm" style="font-weight: bold;">‚è∏Ô∏è Pausar</button>
        </div>
      </div>

      <div class="col-6">
        <h3 style="color: #f4d03f; text-align: center; font-size: 28px;">üèÜ RANKING DO SALOON üèÜ</h3>
        <div id="historico" class="list-group" style="max-height: 250px; overflow-y: auto;"></div>
        <p id="totalPontos" class="fw-semibold" style="color: #f4d03f; text-align: center; font-size: 16px; margin-top: 15px;">üíé Ouro Total: 0</p>

        <h4 style="color: #c41e3a; text-align: center; font-size: 20px; margin-top: 20px;">üëë LENDA DO SALOON (+1000 ouro) üëë</h4>
        <ul id="eliteList" class="list-group mb-3" style="max-height: 200px; overflow-y: auto;"></ul>

        <form id="buscaForm" class="mt-3">
          <input type="text" id="nomeBusca" class="form-control mb-2" placeholder="üîç Procurar Pistoleiro" required>
          <button type="submit" class="btn btn-primary" style="font-weight: bold;">üîé BUSCAR</button>
        </form>

        <button id="limparHistorico" class="btn btn-danger mt-3" style="width: 100%; font-weight: bold;">üí£ EXPLODIR O RANKING üí£</button>
      </div>
    </div>
  </div>

  <script>
  // =================== VARI√ÅVEIS ===================
  let usuario = null;
  let pontuacao = 0;
  let pausado = false;
  const linhas = 10, colunas = 10;
  
  // Cores √∫nicas para cada tipo de pe√ßa (I, O, T, L, J, S, Z)
  const coresPecas = [
    '#00ffff', // I - Cyan
    '#ffff00', // O - Yellow
    '#9933ff', // T - Purple
    '#ff9900', // L - Orange
    '#0066ff', // J - Blue
    '#00ff00', // S - Green
    '#ff0000'  // Z - Red
  ];

  // Rastreia o √≠ndice da pe√ßa atual para usar sua cor
  let indicePecaAtual = -1;
  
    const Pecas = [
      // I
      [[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],
      // O
      [[0,0,0,0],[0,1,1,0],[0,1,1,0],[0,0,0,0]],
      // T
      [[0,0,0,0],[0,1,1,1],[0,0,1,0],[0,0,0,0]],
      // L
      [[0,0,0,0],[0,1,0,0],[0,1,0,0],[0,1,1,0]],
      // J
      [[0,0,0,0],[0,0,1,0],[0,0,1,0],[0,1,1,0]],
      // S
      [[0,0,0,0],[0,0,1,1],[0,1,1,0],[0,0,0,0]],
      // Z
      [[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0]]
    ];

    const loginTela = document.getElementById("loginTela");
    const cadastroTela = document.getElementById("cadastroTela");
    const jogoTela = document.getElementById("jogoTela");
    loginTela.style.display = "block";

    // =================== TROCA DE TELAS ===================
    document.getElementById("mostrarCadastro").onclick = () => {
      loginTela.style.display = "none";
      cadastroTela.style.display = "block";
    };
    document.getElementById("voltarLogin").onclick = () => {
      cadastroTela.style.display = "none";
      loginTela.style.display = "block";
    };

    // =================== LOGIN ===================
    document.getElementById("btnLogin").onclick = async () => {
      const nome = document.getElementById("loginUsuario").value.trim();
      const senha = document.getElementById("loginSenha").value.trim();
      if (!nome || !senha) return alert("Preencha todos os campos.");

     const { data: jogador, error } = await supabase
  .from("Tetris")
  .select("*")
  .eq("Usuario", nome)
  .single();

      if (error || !jogador) return alert("Usu√°rio n√£o encontrado.");
      if (jogador.Senha !== senha) return alert("Senha incorreta!");

      usuario = nome;
      document.getElementById("loginUsuario").value = "";
      document.getElementById("loginSenha").value = "";
      iniciarJogo();
    };

    // =================== CADASTRO (CORRIGIDO) ===================
document.getElementById("btnCadastro").onclick = async () => {
  const nome = document.getElementById("cadastroUsuario").value.trim();
  const senha = document.getElementById("cadastroSenha").value.trim();
  const fileInput = document.getElementById("cadastroFoto");
  const arquivo = fileInput.files[0];

  if (!nome || senha.length < 3) {
    return alert("Usu√°rio ou senha inv√°lidos.");
  }

  try {
    // Verifica se j√° existe o usu√°rio
    const { data: existente, error: erroBusca } = await supabase
      .from("Tetris")
      .select("Usuario")
      .eq("Usuario", nome)
      .maybeSingle();

    if (erroBusca) {
      console.error("Erro ao buscar usu√°rio:", erroBusca);
      return alert("Erro ao verificar usu√°rio. Veja o console.");
    }

    if (existente) {
      return alert("Usu√°rio j√° existe!");
    }

    let fotoURL = null;

    // Se houver arquivo, fazer upload
    if (arquivo) {
      const nomeArquivo = `${Date.now()}_${nome}_${arquivo.name}`;
      const { data, error: erroUpload } = await supabase.storage
        .from("fotos-tetris")
        .upload(nomeArquivo, arquivo);

      if (erroUpload) {
        console.error("Erro ao fazer upload:", erroUpload);
        return alert("Erro ao fazer upload da foto. Veja o console.");
      }

      // Pegar URL p√∫blica da foto
      const { data: publicData } = supabase.storage
        .from("fotos-tetris")
        .getPublicUrl(nomeArquivo);
      
      fotoURL = publicData?.publicUrl;
    }

    // Insere novo usu√°rio
    const { error: erroInsert } = await supabase
      .from("Tetris")
      .insert([{ 
        Usuario: nome, 
        Senha: senha, 
        Pontuacao: 0,
        fotoURL: fotoURL
      }]);

    if (erroInsert) {
      console.error("Erro ao inserir usu√°rio:", erroInsert);
      return alert("Erro ao criar conta. Veja o console.");
    }

    alert("‚úÖ Conta criada com sucesso!");
    document.getElementById("cadastroUsuario").value = "";
    document.getElementById("cadastroSenha").value = "";
    fileInput.value = "";
    cadastroTela.style.display = "none";
    loginTela.style.display = "block";
  } catch (err) {
    console.error("Erro inesperado:", err);
    alert("Erro inesperado ao cadastrar. Veja o console.");
  }

};

    // =================== FUN√á√ïES DO JOGO ===================
    function CriarMapa() {
      return Array.from({length: linhas}, () => Array(colunas).fill(0));
    }

    function ExibirMapa(mapa, pecaAtual) {
      const container = document.getElementById("tetris");
      container.innerHTML = '';
      mapa.forEach((linha, i) => {
        linha.forEach((celula, j) => {
          const div = document.createElement("div");
          div.className = 'celula';
          
          // Verifica se a c√©lula faz parte da pe√ßa em queda
          let isPiece = false;
          if (pecaAtual) {
            for (let x = 0; x < pecaAtual.forma.length && !isPiece; x++) {
              for (let y = 0; y < pecaAtual.forma[x].length && !isPiece; y++) {
                if (pecaAtual.forma[x][y] === 1) {
                  const li = pecaAtual.linha + x;
                  const co = pecaAtual.coluna + y;
                  if (i === li && j === co) {
                    isPiece = true;
                  }
                }
              }
            }
          }
          
          if (mapa[i][j] !== 0) {
            // c√©lula j√° fixada: cont√©m a cor da pe√ßa que fixou
            div.style.backgroundColor = mapa[i][j];
          } else if (isPiece) {
            // pe√ßa em queda: usa a cor √∫nica da pe√ßa atual
            div.style.backgroundColor = coresPecas[indicePecaAtual] || '#ffffff';
          } else {
            // fundo escuro quando vazio
            div.style.backgroundColor = '#1a1410';
          }
          container.appendChild(div);
        });
      });
    }

    function NovaPeca() {
      const hora = Date.now();
      indicePecaAtual = hora % Pecas.length; // Rastreia qual tipo de pe√ßa
      // centraliza pe√ßa na largura do mapa (as pe√ßas s√£o definidas em 4 colunas)
      const colunaInicial = Math.floor(colunas / 2) - 2;
      return { forma: Pecas[indicePecaAtual], linha: 0, coluna: colunaInicial };
    }

    function Colisao(peca, mapa) {
      for (let i = 0; i < peca.forma.length; i++) {
        for (let j = 0; j < peca.forma[i].length; j++) {
          if (peca.forma[i][j] === 1) {
            const li = peca.linha + i;
            const co = peca.coluna + j;
            if (li < 0 || li >= linhas || co < 0 || co >= colunas) return true;
            if (mapa[li][co] !== 0) return true;
          }
        }
      }
      return false;
    }

    function FixarPeca(peca, mapa) {
      // Quando uma pe√ßa fixa, armazena a cor √∫nica da pe√ßa
      peca.forma.forEach((pl, i) => {
        pl.forEach((pc, j) => {
          if (pc === 1) {
            const li = peca.linha + i;
            const co = peca.coluna + j;
            if (li >= 0 && li < linhas && co >= 0 && co < colunas) {
              // Armazena a cor √∫nica da pe√ßa que foi fixada
              mapa[li][co] = coresPecas[indicePecaAtual] || '#ffffff';
            }
          }
        });
      });
    }

    function LimparLinhas(mapa) {
      // Remove todas as linhas completas corretamente, mesmo quando v√°rias est√£o adjacentes
      const novas = [];
      let removidas = 0;
      for (let i = 0; i < mapa.length; i++) {
        // linha completa quando todas as c√©lulas n√£o s√£o 0 (ou seja, j√° fixadas)
        if (mapa[i].every(c => c !== 0)) {
          removidas++;
        } else {
          novas.push(mapa[i]);
        }
      }
      // Adiciona linhas vazias no topo para manter o tamanho
      for (let i = 0; i < removidas; i++) {
        novas.unshift(Array(colunas).fill(0));
      }
      // Atualiza o mapa in-place (novas tem tamanho linhas)
      for (let i = 0; i < linhas; i++) mapa[i] = novas[i];
      // Pontua√ß√£o: 100 por linha removida
      pontuacao += 100 * removidas;
    }

    function Rotacionar(peca) {
      const totalLinhas = peca.forma.length;
      const totalColunas = peca.forma[0].length;
      let nova = [];
      for (let c = 0; c < totalColunas; c++) {
        nova[c] = [];
        for (let l = totalLinhas - 1; l >= 0; l--) {
          nova[c].push(peca.forma[l][c]);
        }
      }
      return nova;
    }

    async function SalvarPontuacao() {
      // Capture the current score immediately (to avoid it being reset before the async save runs)
      const pontosAntes = pontuacao;

      // Busca o jogador; se n√£o existir, insere; se existir, atualiza se a pontua√ß√£o for maior
      const { data: jogador, error } = await supabase
        .from("Tetris")
        .select("*")
        .eq("Usuario", usuario)
        .maybeSingle();

      if (error) {
        console.error('Erro ao buscar jogador para salvar pontuacao', error);
        return;
      }

      const atual = jogador?.Pontuacao || 0;
      const novaPontuacao = pontosAntes > atual ? pontosAntes : atual;

      if (!jogador) {
        // cria o registro caso n√£o exista (usu√°rio pode ter sido criado de outra forma)
        const { error: errIns } = await supabase.from('Tetris').insert([
          { Usuario: usuario, Senha: null, Pontuacao: novaPontuacao }
        ]);
        if (errIns) console.error('Erro ao inserir jogador ao salvar pontua√ß√£o', errIns);
      } else {
        const { error: errUp } = await supabase.from('Tetris').update({ Pontuacao: novaPontuacao }).eq('Usuario', usuario);
        if (errUp) console.error('Erro ao atualizar pontua√ß√£o', errUp);
      }

      atualizarRanking();
    }

    async function atualizarRanking() {
      const { data: ranking } = await supabase
        .from("Tetris")
        .select("Usuario, Pontuacao, fotoURL")
        .order("Pontuacao", { ascending: false });

      const ul = document.getElementById("historico");
      ul.innerHTML = '';
      ranking.forEach(p => {
        const li = document.createElement("li");
        li.className = 'list-group-item d-flex align-items-center';
        li.style.padding = '10px';
        
        // Foto de perfil
        if (p.fotoURL) {
          const img = document.createElement("img");
          img.src = p.fotoURL;
          img.style.width = '96px';
          img.style.height = '96px';
          img.style.borderRadius = '0';
          img.style.marginRight = '12px';
          img.style.objectFit = 'cover';
          img.style.border = '3px solid #8b6f47';
          img.style.boxShadow = '0 0 10px rgba(0,0,0,.8)';
          li.appendChild(img);
        } else {
          const placeholder = document.createElement("div");
          placeholder.style.width = '96px';
          placeholder.style.height = '96px';
          placeholder.style.borderRadius = '0';
          placeholder.style.backgroundColor = '#8b6f47';
          placeholder.style.border = '3px solid #3d2817';
          placeholder.style.marginRight = '12px';
          placeholder.style.display = 'flex';
          placeholder.style.alignItems = 'center';
          placeholder.style.justifyContent = 'center';
          placeholder.style.fontSize = '48px';
          placeholder.style.boxShadow = '0 0 10px rgba(0,0,0,.8)';
          placeholder.textContent = 'ü§†';
          li.appendChild(placeholder);
        }
        
        // Nome e pontua√ß√£o
        const info = document.createElement("span");
        info.textContent = `${p.Usuario} ‚Äî ${p.Pontuacao} üí∞`;
        info.style.color = '#f4d03f';
        info.style.fontWeight = 'bold';
        li.appendChild(info);
        ul.appendChild(li);
      });

  const elite = ranking.filter(p => p.Pontuacao >= 1000);
  const soma = ranking.reduce((a, p) => a + p.Pontuacao, 0);

  document.getElementById("totalPontos").textContent = `üíé Ouro Total: ${soma}`;
      const eliteUl = document.getElementById("eliteList");
      eliteUl.innerHTML = '';
      elite.forEach(p => {
        const li = document.createElement("li");
        li.className = 'list-group-item d-flex align-items-center';
        li.style.padding = '10px';
        li.style.backgroundColor = '#5d4e37';
        
        if (p.fotoURL) {
          const img = document.createElement("img");
          img.src = p.fotoURL;
          img.style.width = '96px';
          img.style.height = '96px';
          img.style.borderRadius = '0';
          img.style.marginRight = '12px';
          img.style.objectFit = 'cover';
          img.style.border = '3px solid #f4d03f';
          img.style.boxShadow = '0 0 15px rgba(244, 208, 63, 0.6)';
          li.appendChild(img);
        } else {
          const placeholder = document.createElement("div");
          placeholder.style.width = '96px';
          placeholder.style.height = '96px';
          placeholder.style.borderRadius = '0';
          placeholder.style.backgroundColor = '#f4d03f';
          placeholder.style.border = '3px solid #3d2817';
          placeholder.style.marginRight = '12px';
          placeholder.style.display = 'flex';
          placeholder.style.alignItems = 'center';
          placeholder.style.justifyContent = 'center';
          placeholder.style.fontSize = '48px';
          placeholder.style.boxShadow = '0 0 15px rgba(244, 208, 63, 0.6)';
          placeholder.textContent = 'ÔøΩ';
          li.appendChild(placeholder);
        }
        
        const info = document.createElement("span");
        info.textContent = `${p.Usuario} ‚Äî ${p.Pontuacao} üí∞`;
        info.style.color = '#f4d03f';
        info.style.fontWeight = 'bold';
        li.appendChild(info);
        eliteUl.appendChild(li);
      });
    }

    // =================== LOOP DO JOGO ===================
  async function iniciarJogo() {
      loginTela.style.display = "none";
      cadastroTela.style.display = "none";
      jogoTela.style.display = "block";
      atualizarRanking();

      let mapa = CriarMapa();
      let pecaAtual = NovaPeca();

      async function AtualizarJogo() {
        if (pausado) return;
        const tentativa = { ...pecaAtual, linha: pecaAtual.linha + 1 };
        if (!Colisao(tentativa, mapa)) {
          pecaAtual.linha++;
        } else {
          FixarPeca(pecaAtual, mapa);
          LimparLinhas(mapa);
          pecaAtual = NovaPeca();
          if (Colisao(pecaAtual, mapa)) {
            alert("Fim de jogo!");
            // Aguarda salvar a pontua√ß√£o antes de resetar
            await SalvarPontuacao();
            mapa = CriarMapa();
            pontuacao = 0;
          }
        }
        ExibirMapa(mapa, pecaAtual);
        document.getElementById('pontuacao').textContent = `Pontua√ß√£o: ${pontuacao}`;
      }

      setInterval(AtualizarJogo, 1000);

      // Bot√£o de pausa
      const pauseBtn = document.getElementById('pauseBtn');
      if (pauseBtn) {
        pauseBtn.addEventListener('click', () => {
          pausado = !pausado;
          pauseBtn.textContent = pausado ? 'Retomar' : 'Pausar';
        });
      }

      document.addEventListener('keydown', e => {
        let temp;
        switch (e.key) {
          case 'ArrowLeft':
            temp = { ...pecaAtual, coluna: pecaAtual.coluna - 1 };
            if (!Colisao(temp, mapa)) pecaAtual.coluna--;
            break;
          case 'ArrowRight':
            temp = { ...pecaAtual, coluna: pecaAtual.coluna + 1 };
            if (!Colisao(temp, mapa)) pecaAtual.coluna++;
            break;
          case 'ArrowDown':
            AtualizarJogo();
            break;
          case 'ArrowUp':
            temp = { ...pecaAtual, forma: Rotacionar(pecaAtual) };
            if (!Colisao(temp, mapa)) pecaAtual.forma = temp.forma;
            break;
        }
        ExibirMapa(mapa, pecaAtual);
      });

      document.getElementById("buscaForm").addEventListener("submit", async e => {
        e.preventDefault();
        const nome = document.getElementById("nomeBusca").value.trim();
        const { data } = await supabase.from("Tetris").select("Usuario, Pontuacao").eq("Usuario", nome).single();
        if (data) alert(`${data.Usuario} ‚Äî ${data.Pontuacao} pontos`);
        else alert("Jogador n√£o encontrado.");
      });

      document.getElementById("limparHistorico").addEventListener("click", async () => {
        await supabase.from("Tetris").delete().neq("Usuario", "");
        atualizarRanking();
        alert("Ranking limpo!");
      });
    }
  </script>
</body>
</html>
